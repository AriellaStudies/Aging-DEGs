---
title: "ThesisTesting_21.01"
output:
  html_document:
    theme: darkly
    highlight: zenburn
---

# Version info: R 3.2.3, Biobase 2.30.0, GEOquery 2.40.0, limma 3.26.8
################################################################
# Setup

Special GEOquery package
```{r eval=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("GEOquery")
```
Other Packages
```{r eval=FALSE}
install.packages('limma')
install.packages('umap')
install.packages("reticulate")
```
Open Libraries
```{r cache=TRUE, include=FALSE}
library(GEOquery)
library(limma)
library(umap)
library(reticulate)
library(knitr)
```
Install Python Packages
```{r cache=TRUE, eval=FALSE}
py_install("pandas")
py_install("regex")
```
Global Options (not in use)
```{r include=FALSE}
knitr::opts_chunk$set(class.source = "bg-info")
```
Python Packages
```{python}
import pandas as pd
import regex as re
```
# Dataset Management (Python)
NCBI GEO was searched for expression datasets on 03/02/2021, filtered to mammalian species with age sets, with 221 results. Results were exported as a detailed text file, then parsed into a dataframe using Python below.
```{python message = FALSE, warning=FALSE}
pattern_organism = re.compile(r"\bOrganism\w*\b")
pattern_GSE = re.compile(r"\bPlatform\w*\b")

list_organism = []
list_GSE = []
list_platform = []
with open("gds_result.txt","rt") as myfile:
    for line in myfile:
        if pattern_organism.search(line) != None:
            betterline = line.replace("Organism:\t","")
            bestline = betterline.replace("\n","")
            list_organism.append(bestline)
        if pattern_GSE.search(line) != None:
            GSE = line.split("Series: ")[1].rsplit()[0]
            list_GSE.append(GSE)
            Platform = line.split("Platform: ")[1].rsplit()[0]
            list_platform.append(Platform)
list_of_lists = [list_GSE, list_organism, list_platform]
df_of_lists = pd.DataFrame(list_of_lists).transpose()
df_of_lists.columns = ["GSE","Organism","Platform"]
print(df_of_lists)
```
# Dataset Management (Manual)
Fill in manual methods here and then import.

-----------------
UNDER CONSTRUCTION
----------------

# Calculate DEGs in each Dataset (R)
GEO2R Function
```{r cache=TRUE}
GEO2R <- function(GSE_number,platform_code,group_binaries,outputs){
  # load series and platform data from GEO
  gset <- getGEO(GSE_number, GSEMatrix =TRUE, AnnotGPL=TRUE)
  if (length(gset) > 1) idx <- grep(platform_code, attr(gset, "names")) else idx <- 1
  gset <- gset[[idx]]
  
  # make proper column names to match toptable 
  fvarLabels(gset) <- make.names(fvarLabels(gset))
  
  # group membership for all samples
  gsms <- group_binaries
  sml <- strsplit(gsms, split="")[[1]]
  
  # filter out excluded samples (marked as "X")
  sel <- which(sml != "X")
  sml <- sml[sel]
  gset <- gset[ ,sel]
  
  # log2 transformation
  ex <- exprs(gset)
  qx <- as.numeric(quantile(ex, c(0., 0.25, 0.5, 0.75, 0.99, 1.0), na.rm=T))
  LogC <- (qx[5] > 100) ||
            (qx[6]-qx[1] > 50 && qx[2] > 0)
  if (LogC) { ex[which(ex <= 0)] <- NaN
    exprs(gset) <- log2(ex) }
  
  # assign samples to groups and set up design matrix
  gs <- factor(sml)
  groups <- make.names(c("young","old"))
  levels(gs) <- groups
  gset$group <- gs
  design <- model.matrix(~group + 0, gset)
  colnames(design) <- levels(gs)
  
  fit <- lmFit(gset, design)  # fit linear model
  
  # set up contrasts of interest and recalculate model coefficients
  cts <- paste(groups[1], groups[2], sep="-")
  cont.matrix <- makeContrasts(contrasts=cts, levels=design)
  fit2 <- contrasts.fit(fit, cont.matrix)
  
  # compute statistics and table of top significant genes
  fit2 <- eBayes(fit2, 0.01)
  tT <- topTable(fit2, adjust="fdr", sort.by="B", number=outputs)
  
  tT <- subset(tT, select=c("ID","adj.P.Val","P.Value","t","B","logFC","Gene.symbol","Gene.title"))
  return(tT)
}
```

Function compounded to filter results by adjusted p<0.01
```{r cache=TRUE}
GEO2R_pFiltered <- function(GSE_number,platform_code,group_binaries,outputs){
  tempTable <- GEO2R(GSE_number,platform_code,group_binaries,outputs)
  filtTable <- tempTable[tempTable$adj.P.Val<0.01,]
  dupTable <- filtTable[!duplicated(filtTable$Gene.symbol),]
  return(dupTable)
}
```

Execute functions on human datasets
(Note that some data-sets have more than 1000 p<0.01)
```{r cache=TRUE, message = FALSE, warning=FALSE}
tT009 <- GEO2R_pFiltered("GSE53890","GPL570","0000000000000XXXXXX1111111111111XXXXXXXXX",1000)
tT023 <- GEO2R_pFiltered("GSE38718","GPL570","0000000000000011111111",1000)
```

Write to files
```{r eval=FALSE}
write.table(tT009, file="tT009.txt", row.names=F, sep="\t")
write.table(tT023, file="tT023.txt", row.names=F, sep="\t")
```

# Calculate Counts Across Datasets (Python)
Define Reader Function
```{python}
def file_to_dict(file_name):
    file = open(file_name)
    header = file.readline()
    for line in file:
      row = line.strip().replace('"', '').split('\t')
      logFC = float(row[5])
      geneID = row[6]
      if logFC > 0:
        if geneID in young_dict:
          young_dict[geneID] += 1
          total_dict[geneID] += 1
        elif geneID in total_dict:
          total_dict[geneID] += 1
          young_dict[geneID] = 1
        else:
          young_dict[geneID] = 1
          total_dict[geneID] = 1
      if logFC < 0:
        if geneID in old_dict:
          old_dict[geneID] += 1
          total_dict[geneID] += (-1)
        elif geneID in total_dict:
          total_dict[geneID] += (-1)
          old_dict[geneID] = 1
        else:
          old_dict[geneID] = 1
          total_dict[geneID] = -1
    file.close()
```
Execute Reader Function
```{python}
young_dict = {}
old_dict = {}
total_dict = {}

file_to_dict('tT009.txt')
file_to_dict('tT023.txt')

```
Convert count dictionary to ordered dataframe
```{python}
total_df = pd.DataFrame.from_dict(total_dict, orient='index')
ordered_df = total_df.sort_values(by=0, ascending=False)
ordered_df
```


# Tasks

## Fundamental Code Structure

* X Establish Rmarkdown, knit, & github work-flow
* X Function working with two sets, both human
* X Analyze only adjust p < 0.01
* X Loop to create dictionary of DEG score counts
* X Convert dictionary to dataframe and/or csv
* X Convert loop to function

## Expansion to all mammals

* O Function working with mouse set
* O Function working with other mammals
* O Convert all data to human form

## Expansion for flexible analyses

* O Database sets with species and tissue type and age status
* O Automate extracting set info based on species/tissue

