---
title: "ThesisTesting_21.01"
output:
  html_document:
    theme: darkly
    highlight: zenburn
---

# Version info: R 3.2.3, Biobase 2.30.0, GEOquery 2.40.0, limma 3.26.8
################################################################
# Setup

Special GEOquery package
```{r eval=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("GEOquery")
```
Other Packages
```{r eval=FALSE}
install.packages('limma')
install.packages('umap')
install.packages("reticulate")
```
Open Libraries
```{r cache = TRUE, include=FALSE}
library(GEOquery)
library(limma)
library(umap)
library(reticulate)
library(knitr)
```
Global Options (not in use)
```{r eval=FALSE}
knitr::opts_chunk$set(class.source = "bg-info")
```


# R Functions
GEO2R Function
```{r cache=TRUE}
GEO2R <- function(GSE_number,platform_code,group_binaries,outputs){
  # load series and platform data from GEO
  gset <- getGEO(GSE_number, GSEMatrix =TRUE, AnnotGPL=TRUE)
  if (length(gset) > 1) idx <- grep(platform_code, attr(gset, "names")) else idx <- 1
  gset <- gset[[idx]]
  
  # make proper column names to match toptable 
  fvarLabels(gset) <- make.names(fvarLabels(gset))
  
  # group membership for all samples
  gsms <- group_binaries
  sml <- strsplit(gsms, split="")[[1]]
  
  # filter out excluded samples (marked as "X")
  sel <- which(sml != "X")
  sml <- sml[sel]
  gset <- gset[ ,sel]
  
  # log2 transformation
  ex <- exprs(gset)
  qx <- as.numeric(quantile(ex, c(0., 0.25, 0.5, 0.75, 0.99, 1.0), na.rm=T))
  LogC <- (qx[5] > 100) ||
            (qx[6]-qx[1] > 50 && qx[2] > 0)
  if (LogC) { ex[which(ex <= 0)] <- NaN
    exprs(gset) <- log2(ex) }
  
  # assign samples to groups and set up design matrix
  gs <- factor(sml)
  groups <- make.names(c("young","old"))
  levels(gs) <- groups
  gset$group <- gs
  design <- model.matrix(~group + 0, gset)
  colnames(design) <- levels(gs)
  
  fit <- lmFit(gset, design)  # fit linear model
  
  # set up contrasts of interest and recalculate model coefficients
  cts <- paste(groups[1], groups[2], sep="-")
  cont.matrix <- makeContrasts(contrasts=cts, levels=design)
  fit2 <- contrasts.fit(fit, cont.matrix)
  
  # compute statistics and table of top significant genes
  fit2 <- eBayes(fit2, 0.01)
  tT <- topTable(fit2, adjust="fdr", sort.by="B", number=outputs)
  
  tT <- subset(tT, select=c("ID","adj.P.Val","P.Value","t","B","logFC","Gene.symbol","Gene.title"))
  return(tT)
}
```
Execution test for GEO2R Function on 2 human datasets
```{r cache=TRUE, message = FALSE, warning=FALSE}
tT01 <- GEO2R("GSE38718","GPL570","0000000000000011111111",1000)
tT02 <- GEO2R("GSE53890","GPL570","0000000000000XXXXXX1111111111111XXXXXXXXX",1000)

kable(tT01[1:10,])
kable(tT02[1:10,])
```

Function compounded to filter results by adjusted p<0.01
```{r cache=TRUE}
GEO2R_pFiltered <- function(GSE_number,platform_code,group_binaries,outputs){
  tempTable <- GEO2R(GSE_number,platform_code,group_binaries,outputs)
  filtTable <- tempTable[tempTable$adj.P.Val<0.01,]
  return(filtTable)
}
```

Execution test for GEO2R_pFiltered
(Note that some data-sets have more than 1000 p<0.01)
```{r cache=TRUE, message = FALSE, warning=FALSE}
tT01_filt <- GEO2R_pFiltered("GSE38718","GPL570","0000000000000011111111",1000)
tT02_filt <- GEO2R_pFiltered("GSE53890","GPL570","0000000000000XXXXXX1111111111111XXXXXXXXX",1000)
```

Write to files
```{r eval=FALSE}
write.table(tT01_filt, file="tT01_filt.txt", row.names=F, sep="\t")
write.table(tT02_filt, file="tT02_filt.txt", row.names=F, sep="\t")
```


# Tasks

## Fundamental Code Structure

* X Establish Rmarkdown, knit, & github work-flow
* X Function working with two sets, both human
* X Analyze only adjust p < 0.01
* O Loop to create dictionary of DEG score counts
* O Export dictionary to csv as final product

## Expansion to all mammals

* O Function working with mouse set
* O Function working with other mammals
* O Convert all data to human form

## Expansion for flexible analyses

* O Database sets with species and tissue type and age status
* O Automate extracting set info based on species/tissue

# Methods Log
WRITING/EXPORTING METHOD
```{r eval=FALSE}
write.table(tT, file="R_Out_1.26.txt", row.names=F, sep="\t")
write.csv(tT, file="R_Out_C.csv", row.names=F)
```

# Testing Areas
TESTING AREA FOR PYTHON
```{python eval=FALSE}
cc_network = {} # empty dictionary that will hold the network

# Read in the file and add dictionary entries:
file = open('yeast_cc_network-Copy1.txt')
for line in file:
    entry = line.strip().split('\t')
    regulator = entry[0]
    regulated = entry[1]
    if regulator in cc_network:
        cc_network[regulator] += [regulated]
    else:
        cc_network[regulator] = [regulated]
        
file.close()

# YOUR ANSWER HERE

# Remember to close the file after reading the data.
print(cc_network) # display the result
```


TESTING AREA FOR R
```{r eval=FALSE}
new.function <- function(a,b,c)  {
  a + b + c
}

new.function(2,3,4)
```

