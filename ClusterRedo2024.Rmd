---
title: "ClusterRedo2024"
output: html_document
date: "2024-06-21"
---

SETUP

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r check-directory}
getwd()  # This should output 'C:/Users/ariel/OneDrive/Documents/GitHub/Aging-DEGs'
```

LIBRARIES

```{r}
library(clusterProfiler)
library(org.Hs.eg.db)
library(DOSE)
library(tidyverse)
library(gridExtra)
library(enrichplot)
library(ggplotify)
library(ggplot2)
library(GOSemSim)
```

IMPORTS

```{r}
# Load the data file
TotalCounts_byGene <- read.csv("Total_Counts.csv")

# Create the filtered dataframe
filtered_TotalCounts_byGene <- subset(TotalCounts_byGene, abs(X0) >= 6)

# Print the first few rows of the filtered dataframe
head(filtered_TotalCounts_byGene)

# Print the last few rows of the filtered dataframe
tail(filtered_TotalCounts_byGene)
```

```{r}
# Subset the rows with positive values in column X0
downregulated_df <- filtered_TotalCounts_byGene[filtered_TotalCounts_byGene$X0 > 0, ]

# Subset the rows with negative values in column X0
upregulated_df <- filtered_TotalCounts_byGene[filtered_TotalCounts_byGene$X0 < 0, ]

# Change the column names of the downregulated_df dataframe
colnames(downregulated_df) <- c("Gene", "Score")

# Change the column names of the upregulated_df dataframe
colnames(upregulated_df) <- c("Gene", "Score")

#preview
head(downregulated_df)
head(upregulated_df)

# Print the number of rows in the dataframe
print(paste("The downregulated dataframe has", nrow(downregulated_df), "rows."))
print(paste("The upregulated dataframe has", nrow(upregulated_df), "rows."))
```

```{r}
# Extract the values in the "Gene" column of the downregulated_df dataframe
downregulated_genes <- paste(downregulated_df$Gene, collapse = ",")

# Extract the values in the "Gene" column of the upregulated_df dataframe
upregulated_genes <- paste(upregulated_df$Gene, collapse = ",")

# Print the gene names for the downregulated and upregulated dataframes
print(paste("downregulated genes: ", downregulated_genes))
print(paste("upregulated genes: ", upregulated_genes))


```



PHASE ONE: DOWNREGULATION

EXTRACT LISTS

```{r}
gene_string <- downregulated_genes
# Split the string into a vector of gene symbols
downregulated_genes <- strsplit(gene_string, split = ",")[[1]]

print(gene_string)
print(downregulated_genes)
```
UPDATE RECENT GENE NAME CHANGES

```{r}
#updating gene names
downregulated_genes <- gsub("DIRC2", "SLC49A4", downregulated_genes)
downregulated_genes <- gsub("ATP5C1", "ATP5F1C", downregulated_genes)
downregulated_genes <- gsub("RFWD2", "COP1", downregulated_genes)

```


```{r}
# Convert gene symbols to Entrez IDs
entrez_ids <- bitr(downregulated_genes, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)

# Extract the Entrez IDs from the converted gene list
downregulated_entrez_ids <- entrez_ids$ENTREZID
print(downregulated_entrez_ids)
```

PERFORM ANALYSIS

```{r}
ego_BP <- enrichGO(gene          = downregulated_entrez_ids,
                  OrgDb         = org.Hs.eg.db,
                  ont           = "BP",
                  pAdjustMethod = "BH",
                  pvalueCutoff  = 0.05,
                  qvalueCutoff  = 0.2)

ego_CC <- enrichGO(gene          = downregulated_entrez_ids,
                  OrgDb         = org.Hs.eg.db,
                  ont           = "CC",
                  pAdjustMethod = "BH",
                  pvalueCutoff  = 0.05,
                  qvalueCutoff  = 0.2)

ego_MF <- enrichGO(gene          = downregulated_entrez_ids,
                  OrgDb         = org.Hs.eg.db,
                  ont           = "MF",
                  pAdjustMethod = "BH",
                  pvalueCutoff  = 0.05,
                  qvalueCutoff  = 0.2)

```

CONVERT TO DATAFRAME MERGED


```{r}
# Convert enrichment results to data frames and add ontology column
ego_BP_df <- as.data.frame(ego_BP) %>% mutate(Ontology = "BP")
ego_CC_df <- as.data.frame(ego_CC) %>% mutate(Ontology = "CC")
ego_MF_df <- as.data.frame(ego_MF) %>% mutate(Ontology = "MF")

# Combine the data frames
ego_all_df <- rbind(ego_BP_df, ego_CC_df, ego_MF_df)

print(ego_all_df)

```

BASIC GRAPH - UNMODDED

```{r}

# Create a horizontal bar plot
ggplot(ego_all_df, aes(x = Description, y = Count, fill = Ontology)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Enriched GO terms",
       x = "GO Term",
       y = "Count") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = "Ontology"))

```
```{r}
# Create a horizontal bar plot sorted by 'Count'
ggplot(ego_all_df, aes(x = reorder(Description, Count, FUN = max), y = Count, fill = Ontology)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Enriched GO terms",
       x = "GO Term",
       y = "Count") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = "Ontology"))
```



SIMPLIFY METHOD TO SIMULATE DAVID

```{r}
simplified_BP <- clusterProfiler::simplify(ego_BP, 
                                           cutoff = 0.7, 
                                           by = "p.adjust", 
                                           select_fun = min, 
                                           measure = "Wang", 
                                           semData = NULL)

simplified_CC <- clusterProfiler::simplify(ego_CC, 
                                           cutoff = 0.7, 
                                           by = "p.adjust", 
                                           select_fun = min, 
                                           measure = "Wang", 
                                           semData = NULL)

simplified_MF <- clusterProfiler::simplify(ego_MF, 
                                           cutoff = 0.7, 
                                           by = "p.adjust", 
                                           select_fun = min, 
                                           measure = "Wang", 
                                           semData = NULL)

```

CONVERT SIMPLIFIED RESULTS TO DATAFRAME

```{r}
# Convert enrichment results to data frames and add ontology column
simple_ego_BP_df <- as.data.frame(simplified_BP) %>% mutate(Ontology = "BP")
simple_ego_CC_df <- as.data.frame(simplified_CC) %>% mutate(Ontology = "CC")
simple_ego_MF_df <- as.data.frame(simplified_MF) %>% mutate(Ontology = "MF")

# Combine the data frames
simple_ego_all_df <- rbind(simple_ego_BP_df, simple_ego_CC_df, simple_ego_MF_df)

print(simple_ego_all_df)

```

SIMPLIFIED GRAPHS

```{r}
# Create a horizontal bar plot sorted by 'Count'
ggplot(simple_ego_all_df, aes(x = reorder(Description, Count, FUN = max), y = Count, fill = Ontology)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Enriched GO terms",
       x = "GO Term",
       y = "Count") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = "Ontology"))
```



EXPLORE CNET NETWORK GRAPHS (FULL DATA, NOT SIMPLIFIED)


```{r}
cnetplot_BP <- cnetplot(ego_BP, categorySize = "pvalue", foldChange = FALSE)
cnetplot_CC <- cnetplot(ego_CC, categorySize = "pvalue", foldChange = FALSE)
cnetplot_MF <- cnetplot(ego_MF, categorySize = "pvalue", foldChange = FALSE)
```

```{r}
cnetplot_BP
cnetplot_CC
cnetplot_MF
```

-----

PHASE TWO: UPREGULATION

EXTRACT LISTS

```{r}
gene_string <- upregulated_genes
# Split the string into a vector of gene symbols
upregulated_genes <- strsplit(gene_string, split = ",")[[1]]

print(gene_string)
print(upregulated_genes)
```
UPDATE RECENT GENE NAME CHANGES

```{r}
#updating gene names
upregulated_genes <- gsub("FAM213A", "PRXL2A", upregulated_genes)
upregulated_genes <- gsub("SEPT4", "SEPTIN4", upregulated_genes)
upregulated_genes <- gsub("FYB", "FYB1", upregulated_genes)

```


```{r}
# Convert gene symbols to Entrez IDs
up_entrez_ids <- bitr(upregulated_genes, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)

# Extract the Entrez IDs from the converted gene list
upregulated_entrez_ids <- up_entrez_ids$ENTREZID
print(upregulated_entrez_ids)
```
```{r}
unmapped_up_symbols <- setdiff(upregulated_genes, up_entrez_ids$SYMBOL)
print(unmapped_up_symbols)
```


PERFORM ANALYSIS

```{r}
up_ego_BP <- enrichGO(gene          = upregulated_entrez_ids,
                  OrgDb         = org.Hs.eg.db,
                  ont           = "BP",
                  pAdjustMethod = "BH",
                  pvalueCutoff  = 0.05,
                  qvalueCutoff  = 0.2)

up_ego_CC <- enrichGO(gene          = upregulated_entrez_ids,
                  OrgDb         = org.Hs.eg.db,
                  ont           = "CC",
                  pAdjustMethod = "BH",
                  pvalueCutoff  = 0.05,
                  qvalueCutoff  = 0.2)

up_ego_MF <- enrichGO(gene          = upregulated_entrez_ids,
                  OrgDb         = org.Hs.eg.db,
                  ont           = "MF",
                  pAdjustMethod = "BH",
                  pvalueCutoff  = 0.05,
                  qvalueCutoff  = 0.2)

```

CONVERT TO DATAFRAME MERGED


```{r}
# Convert enrichment results to data frames and add ontology column
up_ego_BP_df <- as.data.frame(up_ego_BP) %>% mutate(Ontology = "BP")
up_ego_CC_df <- as.data.frame(up_ego_CC) %>% mutate(Ontology = "CC")
up_ego_MF_df <- as.data.frame(up_ego_MF) %>% mutate(Ontology = "MF")

# Combine the data frames
up_ego_all_df <- rbind(up_ego_BP_df, up_ego_CC_df, up_ego_MF_df)

print(up_ego_all_df)

```

BASIC GRAPH - UNMODDED

```{r}

# Create a horizontal bar plot
ggplot(up_ego_all_df, aes(x = Description, y = Count, fill = Ontology)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Enriched GO terms",
       x = "GO Term",
       y = "Count") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = "Ontology"))

```

```{r}
# Create a horizontal bar plot sorted by 'Count'
ggplot(up_ego_all_df, aes(x = reorder(Description, Count, FUN = max), y = Count, fill = Ontology)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Enriched GO terms",
       x = "GO Term",
       y = "Count") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = "Ontology"))
```



SIMPLIFY METHOD TO SIMULATE DAVID

```{r}
up_simplified_BP <- clusterProfiler::simplify(up_ego_BP, 
                                           cutoff = 0.7, 
                                           by = "p.adjust", 
                                           select_fun = min, 
                                           measure = "Wang", 
                                           semData = NULL)

up_simplified_CC <- clusterProfiler::simplify(up_ego_CC, 
                                           cutoff = 0.7, 
                                           by = "p.adjust", 
                                           select_fun = min, 
                                           measure = "Wang", 
                                           semData = NULL)

up_simplified_MF <- clusterProfiler::simplify(up_ego_MF, 
                                           cutoff = 0.7, 
                                           by = "p.adjust", 
                                           select_fun = min, 
                                           measure = "Wang", 
                                           semData = NULL)

```

CONVERT SIMPLIFIED RESULTS TO DATAFRAME

```{r}
# Convert enrichment results to data frames and add ontology column
up_simple_ego_BP_df <- as.data.frame(up_simplified_BP) %>% mutate(Ontology = "BP")
up_simple_ego_CC_df <- as.data.frame(up_simplified_CC) %>% mutate(Ontology = "CC")
up_simple_ego_MF_df <- as.data.frame(up_simplified_MF) %>% mutate(Ontology = "MF")

# Combine the data frames
up_simple_ego_all_df <- rbind(up_simple_ego_BP_df, up_simple_ego_CC_df, up_simple_ego_MF_df)

print(up_simple_ego_all_df)

```

SIMPLIFIED GRAPHS

```{r}
# Create a horizontal bar plot sorted by 'Count'
ggplot(up_simple_ego_all_df, aes(x = reorder(Description, Count, FUN = max), y = Count, fill = Ontology)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Enriched GO terms",
       x = "GO Term",
       y = "Count") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = "Ontology"))
```



EXPLORE CNET NETWORK GRAPHS (FULL DATA, NOT SIMPLIFIED)


```{r}
cnetplot_BP <- cnetplot(ego_BP, categorySize = "pvalue", foldChange = FALSE)
cnetplot_CC <- cnetplot(ego_CC, categorySize = "pvalue", foldChange = FALSE)
cnetplot_MF <- cnetplot(ego_MF, categorySize = "pvalue", foldChange = FALSE)
```

```{r}
cnetplot_BP
cnetplot_CC
cnetplot_MF
```
